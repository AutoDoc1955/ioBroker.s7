<html>

<!-- these 4 files always have to be included -->
<link rel="stylesheet" type="text/css" href="../../lib/css/themes/jquery-ui/redmond/jquery-ui.min.css"/>

<link rel="stylesheet" type="text/css" href="../../lib/css/jqGrid/ui.jqgrid-4.5.4.css"/>
<link rel="stylesheet" type="text/css" href="../../lib/css/jquery.multiselect-1.13.css"/>
<script type="text/javascript" src="../../lib/js/jquery-1.11.1.min.js"></script>
<script type="text/javascript" src="../../lib/js/jquery-ui-1.10.3.full.min.js"></script>
<script type="text/javascript" src="../../socket.io/socket.io.js"></script>
<script type="text/javascript" src="../../lib/js/jquery-ui-1.10.3.full.min.js"></script>
<script type="text/javascript" src="../../lib/js/jqGrid/jquery.jqGrid-4.5.4.min.js"></script>
<script type="text/javascript" src="../../lib/js/jqGrid/grid.locale-all.js"></script>

<!-- optional: use multiselect
<link rel="stylesheet" type="text/css" href="../../lib/css/jquery.multiselect-1.13.css"/>
<script type="text/javascript" src="../../lib/js/jquery.multiselect-1.13.min.js"></script>
-->

<!-- these two file always have to be included -->
<link rel="stylesheet" type="text/css" href="../../css/adapter.css"/>
<script type="text/javascript" src="../../js/translate.js"></script>
<script type="text/javascript" src="../../js/adapter-settings.js"></script>
<style>
    .ui-tabs-panel {
        height: calc(100% - 70px);
        padding: 0px !important;
    }

    .table_header {
        background-color: blue;
        color: white;
    }

    .ip {
        width: 150px;
        text-align: right;
    }

    .ui-jqgrid-titlebar {
        display: none;
    }
</style>

<!-- you have to define 2 functions in the global scope: -->
<script type="text/javascript">

    // Dictionary (systemDictionary is global variable from adapter-settings.js)
    systemDictionary = {};


    // the function loadSettings has to exist ...
    function load(settings) {
        $("#adapter-container").tabs();
        var inputs = settings.inputs|| [];
        var outputs = settings.outputs || [];
        var merker = settings.merker || [];
        var counter = settings.counter || [];
        var timer = settings.timer || [];
        var dbs = settings.dbs || [];
        var params = settings.params || {
                    ip: "192.168.0.1",
                    rack: 0,
                    slot: 2,
                    pool: 1000,
               };



        setTimeout(function () {

            $.each($(".s7_params"), function(){
                if($(this).hasClass("check")){
                    if (params[$(this).attr("id").split("_")[1]]) {
                        document.getElementById($(this).attr("id")).checked = params[$(this).attr("id").split("_")[1]]
                    }
                }else{
                    $(this).val(params[$(this).attr("id").split("_")[1]])
                }
            });

            $.each($('.s7_grid'), function () {
                var lastsel;
                var _id = $(this).attr("id");
                $("#" + _id).jqGrid({
                    datatype: "local",
                    data: eval(_id.split("_")[1]),
                    rowNum: -1,
                    viewrecords: true,
                    height: "auto",
//                    pager: "#pager-"+_id,
                    colNames: ['Name', 'Adress', 'Type', 'Description', 'Pool', 'RW'],
                    colModel: [
                        {name: 'Name', index: 'id', width: 250, editable: true},
                        {name: 'Adress', index: 'Adress', width: 70, editable: true, sorttype:"float"},
                        {name: 'Type', index: 'Type', width: 70, editable: true},
                        {name: 'Description', index: 'Description', width: 300, editable: true},
                        {name: 'Pool', index: 'Pool', width: 40, editable: false, edittype: 'checkbox', align: 'center', formatter: 'checkbox'},
                        {name: 'RW', index: 'RW', width: 40, editable: false, edittype: 'checkbox', align: 'center', formatter: 'checkbox'},

                    ],
                    onSelectRow: function (id) {
                        if (id && id !== lastsel) {
                            $("#" + _id).jqGrid('restoreRow', lastsel);
                            $("#" + _id).jqGrid('editRow', id, true);
                            lastsel = id;
                        }
                    }
                });
            })
        });
    }

        // ... and the function save has to exist.
        // you have to make sure the callback is called with the settings object as first param!
        function save(callback) {
            // example: select elements with class=value and build settings object
            var obj = {params:{}};

            $.each($('.s7_grid'), function () {
                var id = $(this).attr("id");
                var key = id.split("_")[1];
                obj[key] = $("#"+id).jqGrid('getRowData');
            });
            $.each($(".s7_params"), function(){
                if($(this).hasClass("check")){

                    obj.params[$(this).attr("id").split("_")[1]] = document.getElementById($(this).attr("id")).checked

                }else{
                    obj.params[$(this).attr("id").split("_")[1]] = $(this).val()
                }
            });

            callback(obj);
        }

        function symbol_import(e) {
            console.log(e)
            var reader = new FileReader();

            reader.onload = function (e) {
                var table;
                var data = {
                    inputs: [],
                    outputs: [],
                    merker: [],
                    counter: [],
                    timer: [],
                    dbs: []

                };
                var text = reader.result;
                text = text.split("126,");
                $.each(text, function () {
                    var typ = this.slice(23, 29).replace(/( )/g, "");

                    var d = {
                        'Name': this.slice(0, 23).replace(/( ){2,}/g, ""),
                        'Adress': this.slice(29, 36).replace(/( )/g, ""),
                        'Type': this.slice(36, 41).replace(/( )/g, ""),
                        'Description': this.slice(46, 126).replace(/( ){2,}/, ""),
                        'Pool': false,
                        'RW': false
                    };

                    if (typ == "E" || typ == "EB" ||typ == "EW" ||typ == "ED"||typ == "PEB"||typ == "PEW"||typ == "PED")data.inputs.push(d);
                    if (typ == "A" || typ == "AB" ||typ == "AW" ||typ == "AD"||typ == "PAB"||typ == "PAW"||typ == "PAD")data.outputs.push(d);
                    if (typ == "M" || typ == "MB" ||typ == "MW" ||typ == "MD")data.merker.push(d);
                    if (typ == "C")data.counter.push(d);
                    if (typ == "T")data.timer.push(d);
                    if (typ == "DB")data.dbs.push(d);


                });

                $.each($('.s7_grid'), function () {

                    var id = $(this).attr("id");
                    $("#" + id).jqGrid('setGridParam',
                            {
                                datatype: 'local',
                                data: data[id.split("_")[1]]
                            })
                            .trigger("reloadGrid");
                });
            };

            reader.readAsText(e[0], "ISO-8859-1");

        }
</script>

<!-- you have to put your config page in a div with id adapter-container -->
<div id="adapter-container">

    <ul>
        <li><a href="#s7_tab_g">General</a></li>
        <li><a href="#s7_tab_i">Inputs</a></li>
        <li><a href="#s7_tab_o">Outputs</a></li>
        <li><a href="#s7_tab_m">Merker</a></li>
        <li><a href="#s7_tab_c">Counter</a></li>
        <li><a href="#s7_tab_t">Timer</a></li>
        <li><a href="#s7_tab_d">DBs</a></li>
    </ul>
    <div id="s7_tab_g" style="display: inline-block">
        <table style="margin-top: 20px; border: 1px solid black; border-collapse: collapse; ">
            <tr  style="border-bottom: 1px solid black;text-align: center " >
                <td colspan="2">PLC Connection:</td>
            </tr>
            <tr>
                <td style="width: 200px">PLC IP Adress:</td>
                <td style="width: 200px"><input class="s7_params" id="s7params_ip"/></td>
            </tr>
            <tr>
                <td>PLC Rack:</td>
                <td><input class="s7_params" id="s7params_rack"/></td>
            </tr>
            <tr>
                <td>PLC Slot:</td>
                <td><input class="s7_params" id="s7params_slot"/></td>
            </tr>
            <tr>
                <td>Pool delay:</td>
                <td><input class="s7_params" id="s7params_pool"/></td>
            </tr>
        </table>
        <table style="margin-top: 20px; border: 1px solid black; border-collapse: collapse; ">
            <tr>
                <td style="text-align: center" colspan="3">Overwrites</td>
            </tr>
            <tr  style="border-bottom: 1px solid black" >
                <td style="width: 200px">Typ</td>
                <td style="width: 65px">Poll all:</td>
                <td style="width: 65px">RW all:</td>
            </tr>
            <tr>
                <td>Inputs</td>
                <td style="text-align: center" ><input type="checkbox" class="s7_params check" id="s7overw_inputs-pool"></td>
                <td style="text-align: center" ><input type="checkbox" class="s7_params check" id="s7overw_inputs-rw"></td>
            </tr>
            <tr>
                <td>Outputs</td>
                <td style="text-align: center" ><input type="checkbox" class="s7_params check" id="s7overw_outputs-pool"></td>
                <td style="text-align: center" ><input type="checkbox" class="s7_params check" id="s7overw_outputs-rw"></td>
            </tr>
            <tr>
                <td>Merker</td>
                <td style="text-align: center" ><input type="checkbox" class="s7_params check" id="s7overw_merker-pool"></td>
                <td style="text-align: center" ><input type="checkbox" class="s7_params check" id="s7overw_merker-rw"></td>
            </tr>
            <tr>
                <td>Counter</td>
                <td style="text-align: center" ><input type="checkbox" class="s7_params check" id="s7overw_counter-pool"></td>
                <td style="text-align: center" ><input type="checkbox" class="s7_params check" id="s7overw_counter-rw"></td>
            </tr>
            <tr>
                <td>Timer</td>
                <td style="text-align: center" ><input type="checkbox" class="s7_params check" id="s7overw_timer-pool"></td>
                <td style="text-align: center" ><input type="checkbox" class="s7_params check" id="s7overw_timer-rw"></td>
            </tr>
            <!--<tr>-->
                <!--<td>DBs</td>-->
                <!--<td style="text-align: center" ><input type="checkbox" class="s7_params" id="s7overw_dbs-pool"></td>-->
                <!--<td style="text-align: center" ><input type="checkbox" class="s7_params" id="s7overw_dbs-rw"></td>-->
            <!--</tr>-->
        </table>
        <table style="margin-top: 20px; border: 1px solid black; border-collapse: collapse; ">
            <tr>
                <td>Import Symbol Datei:</td>

            </tr>
            <tr>
                <td><input onchange="symbol_import(this.files)" type="file" accept=".asc" id="symol_import"/></td>
            </tr>
        </table>
    </div>
    <div id="s7_tab_i" style="overflow: auto">
        <table id="s7_inputs" class="s7_grid"></table>
        <div id="pager-s7_inputs"></div>
    </div>
    <div id="s7_tab_o" style="overflow: auto">
        <table id="s7_outputs" class="s7_grid"></table>
        <div id="pager-s7_outputs"></div>
    </div>
    <div id="s7_tab_m" style="overflow: auto">
        <table id="s7_merker" class="s7_grid"></table>
        <div id="pager-s7_merker"></div>
    </div>
    <div id="s7_tab_c" style="overflow: auto">
        <table id="s7_counter" class="s7_grid"></table>
        <div id="pager-s7_counter"></div>
    </div>
    <div id="s7_tab_t" style="overflow: auto">
        <table id="s7_timer" class="s7_grid"></table>
        <div id="pager-s7_timer"></div>
    </div>
    <div id="s7_tab_d" style="overflow: auto">
        <!--<table id="s7_dbs" class="s7_grid"></table>-->
        <table id="s7_dbs"></table>
        <div id="pager-s7_dbs"></div>
    </div>


</div>

</html>
